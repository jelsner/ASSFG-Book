---
title: "Rendering elevation with ray shading"
output: html_document
editor_options: 
  chunk_output_type: console
---

From https://www.rayshader.com/

```{r}
library(rayshader)
```

Load a tif (tagged image file) with the `raster()` function from the **raster** package.
```{r}
library(rgdal)

loadzip <- tempfile() 
download.file("https://tylermw.com/data/dem_01.tif.zip",
              loadzip)
localtif <- raster::raster(unzip(loadzip, "dem_01.tif"))
unlink(loadzip)
```

And convert it to a matrix using the `raster_to_matrix()` function from the **rayshader** package.
```{r}
elmat <- rayshader::raster_to_matrix(localtif)
```

We use one of the built-in textures.
```{r}
library(tidyverse)

elmat %>%
  sphere_shade(texture = "desert") %>%
  plot_map()
```

We shift the default sun direction of 315 degrees (NW) to 0 (N) using the `sunangle =` argument.
```{r}
elmat %>%
  sphere_shade(texture = "desert",
               sunangle = 0) %>%
  plot_map()
```

The default texture is `imhof1`. It is either a square matrix indicating the spherical texture mapping or a string indicating a built-in color palette.
```{r}
elmat %>%
  sphere_shade(texture = "imhof1",
               sunangle = 0) %>%
  plot_map()
```

The `detect_water()` and the `add_water()` functions together add a water layer to the map.
```{r}
elmat %>%
  sphere_shade(texture = "imhof1") %>%
  add_water(detect_water(elmat)) %>%
  plot_map()
```

We can add a ray-traced layer from that sun direction as well. Ray tracing allows for simulating a wide variety of optical effects, such as reflection and refraction, scattering, and dispersion phenomena (such as chromatic aberration). It does this by tracing the path of light as pixels in the image plane and simulating the effects of the light encounters with virtual objects. This takes a bit more time to render.
```{r}
elmat %>%
  sphere_shade(texture = "desert") %>%
  add_water(detect_water(elmat), color = "desert") %>%
  add_shadow(ray_shade(elmat), max_darken = .5) %>%
  plot_map()
```

We add an ambient occlusion shadow layer, which models lighting from atmospheric scattering. This takes even more time to render but the result is rather stunning.
```{r}
elmat %>%
  sphere_shade(texture = "desert") %>%
  add_water(detect_water(elmat), color = "desert") %>%
  add_shadow(ray_shade(elmat), .5) %>%
  add_shadow(ambient_shade(elmat), 0) %>%
  plot_map()
```

Another example: 10-meter (aggregated from 1 meter) DEM from Tallahassee. (The aggregation was done on my laptop in the `rayshader.Rmd` file on the desktop. The 1 meter DEM was about 350 MB. The aggregated 10 meter DEM is about 4 MB).
```{r}
df <- tempfile()
download.file("myweb.fsu.edu/jelsner/temp/data/DEM_Tallahassee_10m.tif", 
              destfile = df)
localimg <- raster::raster(df)
plot(localimg)
```

Where is this? Overlay a street map. FDOT: https://www.fdot.gov/statistics/gis/default.shtm#Designated Download the `Basemap_routes` shapefile. Leon County is coded as "55".

Download from `myweb.fsu.edu/jelsner/temp/data/Basemap_routes.zip`.
```{r}
library(sf)

routes.sf <- read_sf(dsn = ".", 
                    layer = "Basemap_routes") %>%
  st_zm() %>%
  dplyr::filter(COUNTY == "55")
plot(st_geometry(routes.sf))
```

Use **tmap** functions for the plotting.
```{r}
library(tmap)

tm_shape(localimg) +
  tm_raster() +
tm_shape(routes.sf) +
  tm_lines()
```

```{r}
elmat <- rayshader::raster_to_matrix(localimg)

elmat %>%
  sphere_shade(texture = "imhof1") %>%
  plot_map()

elmat %>%
  sphere_shade(texture = "imhof1") %>%
  add_water(detect_water(elmat), color = "imhof1") %>%
  add_shadow(ray_shade(elmat), .5) %>%
  add_shadow(ambient_shade(elmat), 0) %>%
  plot_map()
```